generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  //  directUrl = env("DIRECT_URL")
}

//===============================================================
// --- Models ---
//===============================================================

model Organization {
  id           String   @id @default(uuid())
  name         String
  logoUrl      String?  @map("logo_url")
  primaryColor String   @default("#3B82F6") @map("primary_color")
  createdAt    DateTime @default(now()) @map("created_at")
  users        User[]

  @@map("Organization")
}

model User {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String   @unique
  passwordHash   String   @map("password_hash")
  role           UserRole
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student      Student?          @relation("UserToStudent")
  meetings     Meeting[]         @relation("CoordinatorMeetings")
  meetingLogs  MeetingLog[]
  comments     ProfileComment[]
  overrides    ProfileOverride[]

  @@map("User")
}

model Student {
  userId               String     @id @map("user_id")
  graduationYear       Int        @map("graduation_year")
  currentGrade         GradeLevel @map("current_grade")
  primaryCoordinatorId String?    @map("primary_coordinator_id")
  profileCompletionPct Int        @default(0) @map("profile_completion_pct")
  coordinatorId        String?    @map("coordinator_id")

  // Relations
  user               User                 @relation("UserToStudent", fields: [userId], references: [id], onDelete: Cascade)
  academicProfile    AcademicProfile?
  personalProfile    PersonalProfile?
  achievements       Achievement[]
  activities         Activity[]
  transcripts        Transcript[]
  testScores         TestScore[]
  projectExperiences ProjectExperience[]
  applications       CollegeApplication[]
  meetings           Meeting[]
  meetingLogs        MeetingLog[]
  goals              ProfileGoal[]
  changeLogs         ChangeLog[]
  profileOverride    ProfileOverride?
  targetColleges     TargetCollege[]

  @@map("Student")
}

// -------------------------------------------------
// --- STUDENT PROFILE MODELS ---
// -------------------------------------------------

model PersonalProfile {
  studentId      String    @id @map("student_id")
  phone          String?
  dateOfBirth    DateTime? @map("date_of_birth")
  currentSchool  String?   @map("current_school")
  schoolLocation String?   @map("school_location")
  createdAt      DateTime  @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("PersonalProfile")
}

model AcademicProfile {
  studentId         String            @id @map("student_id")
  curriculumType    CurriculumType    @map("curriculum_type")
  gradingSystemType GradingSystemType @map("grading_system_type")
  currentGpa        String?           @map("current_gpa")
  createdAt         DateTime          @default(now()) @map("created_at")
  student           Student           @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("AcademicProfile")
}

model Subject {
  id             String         @id @default(cuid())
  subjectName    String         @map("subject_name")
  curriculumType CurriculumType @map("curriculum_type")

  @@unique([subjectName, curriculumType]) // Critical for seed-subjects.ts
  @@map("Subject")
}

model Transcript {
  id          String      @id @default(cuid())
  studentId   String      @map("student_id")
  courseName  String      @map("course_name")
  gradeLevel  GradeLevel  @map("grade_level")
  semester    Semester
  gradeValue  String      @map("grade_value")
  honorsLevel HonorsLevel @default(Standard) @map("honors_level")
  isBoardExam Boolean     @default(false) @map("is_board_exam")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  student     Student     @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@unique([studentId, courseName, gradeLevel, semester])
  @@map("Transcript")
}

model Activity {
  id           String   @id @default(cuid())
  studentId    String   @map("student_id")
  activityName String   @map("activity_name")
  category     ActivityCategory // Changed from String to the Enum
  role         String?
  gradeLevel   GradeLevel @map("grade_level")
  hoursPerWeek Int      @map("hours_per_week")
  weeksPerYear Int      @map("weeks_per_year")
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  student      Student  @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("Activity")
}

model ProjectExperience {
  id             String         @id @default(cuid())
  studentId      String         @map("student_id")
  title          String
  experienceType ExperienceType @map("experience_type")
  organization   String?
  roleTitle      String?        @map("role_title")
  startDate      DateTime       @map("start_date")
  endDate        DateTime?      @map("end_date")
  isOngoing      Boolean        @default(false) @map("is_ongoing")
  description    String?
  createdAt      DateTime       @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("ProjectExperience")
}

model Achievement {
  id               String            @id @default(cuid())
  studentId        String            @map("student_id")
  achievementType  AchievementType   @map("achievement_type")
  title            String
  organization     String?
  gradeLevel       GradeLevel?       @map("grade_level")
  dateAchieved     DateTime?         @map("date_achieved")
  description      String?
  recognitionLevel RecognitionLevel? @map("recognition_level")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  student          Student           @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("Achievement")
}

// -------------------------------------------------
// --- COLLEGE PREP MODELS ---
// -------------------------------------------------

model College {
  id             String               @id @default(cuid())
  name           String
  country        String               @default("United States")
  acceptanceRate Float?               @map("acceptance_rate")
  avgGpa         Float?               @map("avg_gpa")
  avgSat         Int?                 @map("avg_sat")
  avgAct         Int?                 @map("avg_act")
  rankingUsNews  Int?                 @map("ranking_us_news")
  isActive       Boolean              @default(true) @map("is_active")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  applications   CollegeApplication[]
  targetColleges TargetCollege[]

  @@unique([name])

  @@map("College")
}

model CollegeApplication {
  id                    String    @id @default(cuid())
  studentId             String    @map("student_id")
  collegeId             String    @map("college_id")
  targetCategory        TargetCategory @map("target_category")
  applicationStatus     ApplicationStatus @map("application_status")
  applicationDeadline   DateTime? @map("application_deadline")
  decisionDeadline      DateTime? @map("decision_deadline")
  essayStatus           String    @default("Not Started") @map("essay_status")
  supplementsStatus     String    @default("Not Started") @map("supplements_status")
  recommendationStatus  String    @default("Not Requested") @map("recommendation_status")
  testScoresSent        Boolean   @default(false) @map("test_scores_sent")
  applicationPortalLink String?   @map("application_portal_link")
  notes                 String?
  decisionReceivedDate  DateTime? @map("decision_received_date")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@unique([studentId, collegeId])

  @@map("CollegeApplication")
}

model TestScore {
  id                  String   @id @default(cuid())
  studentId           String   @map("student_id")
  testType            String   @map("test_type") // e.g., SAT, ACT, Duolingo
  testDate            DateTime @map("test_date")
  compositeScore      Int      @map("composite_score")
  mathScore           Int?     @map("math_score")
  englishScore        Int?     @map("english_score")
  scienceScore        Int?     @map("science_score")
  readingWritingScore Int?     @map("reading_writing_score")
  createdAt           DateTime @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("TestScore")
}

model TargetCollege {
  id             String         @id @default(cuid())
  studentId      String         @map("student_id")
  collegeId      String         @map("college_id")
  targetCategory TargetCategory @map("target_category")
  priority       Int?

  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  @@unique([studentId, collegeId])

  @@map("TargetCollege")
}

// -------------------------------------------------
// --- MEETINGS & CHANGE LOGS MODELS ---
// -------------------------------------------------

model Meeting {
  id              String      @id @default(cuid())
  studentId       String      @map("student_id")
  coordinatorId   String      @map("coordinator_id")
  meetingDate     DateTime    @map("meeting_date")
  durationMinutes Int?        @map("duration_minutes")
  meetingType     MeetingType @default(Regular) @map("meeting_type")
  topicsDiscussed String[]    @map("topics_discussed")
  notes           String?
  actionItems     String[]    @map("action_items")
  nextMeetingDate DateTime?   @map("next_meeting_date")
  studentMood     String?     @map("student_mood")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user    User    @relation("CoordinatorMeetings", fields: [coordinatorId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("Meeting")
}

model MeetingLog {
  id        String   @id @default(cuid())
  meetingId String?  @map("meeting_id")
  userId    String   @map("user_id")
  studentId String   @map("student_id")
  logEntry  String   @map("log_entry")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id])
  student Student @relation(fields: [studentId], references: [userId])

  @@map("MeetingLog")
}

model ChangeLog {
  id          String       @id @default(cuid())
  studentId   String       @map("student_id")
  changeType  ChangeType   @map("change_type")
  entityType  String       @map("entity_type")
  entityId    String?      @map("entity_id")
  action      ChangeAction
  fieldName   String?      @map("field_name")
  oldValue    String?      @map("old_value")
  newValue    String?      @map("new_value")
  description String
  createdAt   DateTime     @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("ChangeLog")
}

model ProfileGoal {
  id            String     @id @default(cuid())
  studentId     String     @map("student_id")
  goalType      GoalType   @map("goal_type")
  category      String
  targetValue   String     @map("target_value")
  currentValue  String     @map("current_value")
  deadline      DateTime?  
  priority      Int?
  notes         String?
  status      GoalStatus @default(Not_Started)

  createdAt   DateTime   @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("ProfileGoal")
}

model ProfileOverride {
  id             String   @id @default(cuid())
  studentId      String   @unique @map("student_id")
  overrideScore  Int      @map("override_score")
  overrideReason String   @map("override_reason")
  overriddenBy   String   @map("overridden_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [overriddenBy], references: [id])
  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@map("ProfileOverride")
}

model ProfileComment {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("ProfileComment")
}

//===============================================================
// --- Enums ---
//===============================================================

enum UserRole {
  counselor
  coordinator
  student
}

enum GradeLevel {
  ninth
  tenth
  eleventh
  twelfth
}

enum CurriculumType {
  CBSE
  ICSE
  IB
  CAIE
  State_Board
  US_High_School
  Other
}

enum GradingSystemType {
  Marks_Out_Of_100
  Percentage
  IB_Scale
  Letter_Grade
  Other
}

enum HonorsLevel {
  Standard
  Honors
  AP
  IB_HL
  IB_SL
}

enum Semester {
  Fall
  Spring
  Full_Year
}

enum AchievementType {
  Award_Honor
  Competition
  Leadership
  Social_Impact
  Extracurricular
}

enum RecognitionLevel {
  School
  Inter_School
  District
  City
  State
  National
  International
}

enum ExperienceType {
  Academic_Project
  Independent_Project
  Research
  Internship
  Summer_Program
  Work_Experience
}

enum ApplicationStatus {
  Planning
  Researching
  Preparing
  In_Progress
  Submitted
  Accepted
  Rejected
  Waitlisted
  Deferred
  Withdrawn
  Not_Started
}

enum GoalType {
  Academic
  Testing
  Activity
  Achievement
  Project
  Other
}

enum ChangeAction {
  Created
  Updated
  Deleted
  Completed
}

enum ChangeType {
  Profile_Update
  Goal_Progress
  New_Addition
  Improvement
  Milestone
}

enum MeetingType {
  Initial
  Regular
  Check_In
  Goal_Review
  Application_Review
  Crisis
  Final
}

enum GoalStatus {
  Not_Started
  In_Progress
  Completed
  Deferred
  Cancelled
}

enum TargetCategory {
  Reach
  Match
  Safety
}

enum ActivityCategory {
  Academic
  Arts_Music
  Athletics
  Community_Service
  Cultural
  Leadership
  Other
}
